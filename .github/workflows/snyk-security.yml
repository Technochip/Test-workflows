name: Example workflow using Snyk

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  security:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write   # REQUIRED to create GitHub issues

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Run Snyk SAST scan
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --sarif-file-output=snyk.sarif

      # 3ï¸âƒ£ Count vulnerabilities safely
      - name: Count total number of vulnerabilities
        run: |
          if [ ! -f snyk.sarif ]; then
            echo "RESULTS_LENGTH=0" >> $GITHUB_ENV
            echo "SARIF file not found, assuming 0 vulnerabilities"
          else
            RESULTS_LENGTH=$(jq '.runs[0].results | length' snyk.sarif)
            echo "RESULTS_LENGTH=$RESULTS_LENGTH" >> $GITHUB_ENV
            echo "Vulnerabilities found: $RESULTS_LENGTH"
          fi

      # 4ï¸âƒ£ Create GitHub Issue if vulnerabilities exist
      - name: Create GitHub Issue on vulnerabilities
        if: env.RESULTS_LENGTH != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const vulnCount = process.env.RESULTS_LENGTH;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Snyk detected ${vulnCount} vulnerabilities`,
              body: `
### ğŸ” Snyk Security Scan Failed

**Total vulnerabilities detected:** ${vulnCount}

ğŸ” **View full scan details:**  
${runUrl}

ğŸ“Œ **Action required:**
- Review Snyk findings
- Fix reported vulnerabilities
- Re-run the workflow

_This issue was automatically created by GitHub Actions._
              `,
              labels: ["security", "snyk", "vulnerability"]
            });

      # 5ï¸âƒ£ Fail the job (security gate)
      - name: Fail the job if vulnerabilities exist
        if: env.RESULTS_LENGTH != '0'
        run: |
          echo "Security vulnerabilities detected. Failing the job."
          exit 1
