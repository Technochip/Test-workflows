name: Snyk SAST Scan

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  security:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Run Snyk SAST scan ONLY
      - name: Run Snyk SAST
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --sarif-file-output=snyk.sarif

      # 3Ô∏è‚É£ Parse SARIF ‚Üí Count vulnerabilities per file
      - name: Parse SARIF for file-wise vulnerability count
        run: |
          if [ ! -f snyk.sarif ]; then
            echo "RESULTS_LENGTH=0" >> $GITHUB_ENV
            echo "FILE_REPORT=" >> $GITHUB_ENV
            exit 0
          fi

          # Total vulnerabilities
          RESULTS_LENGTH=$(jq '.runs[0].results | length' snyk.sarif)
          echo "RESULTS_LENGTH=$RESULTS_LENGTH" >> $GITHUB_ENV

          # File-wise vulnerability count
          FILE_REPORT=$(jq -r '
            .runs[0].results[]
            | .locations[0].physicalLocation.artifactLocation.uri
            ' snyk.sarif \
            | sort | uniq -c \
            | sed "s/^/‚Ä¢ /"
          )

          echo "FILE_REPORT<<EOF" >> $GITHUB_ENV
          echo "$FILE_REPORT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Create GitHub Issue if vulnerabilities exist
      - name: Create GitHub Issue
        if: env.RESULTS_LENGTH != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const vulnCount = process.env.RESULTS_LENGTH;
            const fileReport = process.env.FILE_REPORT;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Snyk SAST found ${vulnCount} vulnerabilities`,
              body: `
### üîê Snyk Static Code Analysis Report

**Total vulnerabilities:** ${vulnCount}

### üìÅ Vulnerabilities by file:
${fileReport}

üîé **Full scan details:**  
${runUrl}

üìå **Action required:**
- Review affected files
- Fix reported issues
- Re-run the workflow

_This issue was automatically created by GitHub Actions._
              `,
              labels: ["security", "snyk", "sast"]
            });

      # 5Ô∏è‚É£ Fail the job if vulnerabilities exist
      - name: Fail job
        if: env.RESULTS_LENGTH != '0'
        run: |
          echo "SAST vulnerabilities detected. Failing the job."
          exit 1
