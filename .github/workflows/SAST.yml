name: SAST

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main
      
  schedule:
    # Daily scan (off-peak)
    - cron: '12 15 * * *'


jobs: 

  snyk:
    name: Snyk Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write

      # If your repository is private, also add:
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@master
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: false # To make workflow fail when vuln detected
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test

          

  

  semgrep:
      name: Semgrep Scan
      runs-on: ubuntu-latest
      permissions:
        contents: read
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      container:
        image: semgrep/semgrep
      if: (github.actor != 'dependabot[bot]')
      steps:
        - uses: actions/checkout@v4
        - run: |
            semgrep ci --json > semgrep.json
            jq '.results[] | select(.extra.severity == "ERROR")' semgrep.json && exit 1 || exit 0


  create_issue:
    name: Create Issue if Vulnerability Found
    needs: [snyk, semgrep]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ SAST Vulnerability Detected",
              body: `
              **Workflow:** ${context.workflow}
              **Branch:** ${context.ref}
              **Commit:** ${context.sha}

              One or more SAST tools detected security vulnerabilities.

              ðŸ”— Run details:
              https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              `
            })


