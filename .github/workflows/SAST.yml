name: SAST

on:
  workflow_dispatch: {}
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main
      



jobs: 

  snyk:
    name: Snyk Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write

      # If your repository is private, also add:
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@master
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: false # To make workflow fail when vuln detected
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test

          

  semgrep:
      name: Semgrep Scan
      runs-on: ubuntu-latest
      permissions:
        contents: read
        actions: read
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      container:
        image: semgrep/semgrep
      if: (github.actor != 'dependabot[bot]')
      steps:
        - uses: actions/checkout@v4
        - run: |
            semgrep ci 


  sonarqube:
      name: SonarQube
      runs-on: ubuntu-latest
      permissions:
        contents: read
        actions: read
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
        - name: SonarQube Scan
          uses: SonarSource/sonarqube-scan-action@v6
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      


  create_issue:
    name: Create / Update Security Issue
    needs: [snyk, semgrep, sonarqube]
    runs-on: ubuntu-latest
    if: always()
  
    permissions:
      contents: read
      issues: write
  
    steps:
      - name: Create / Update GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "security:sast";
            const title = "üö® SAST Vulnerabilities Detected";
  
            // 1Ô∏è‚É£ Check workflow result
            const snykResult = "${{ needs.snyk.result }}";
            const semgrepResult = "${{ needs.semgrep.result }}";
            const sonarqubeResult = "${{ needs.sonarqube.result }}";
            const hasFailures = snykResult === "failure" || semgrepResult === "failure" ||sonarqubeResult === "failure";
  
            // 2Ô∏è‚É£ Find existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label
            });
  
            const existingIssue = issues.data.find(i => i.title === title);
  
            // 3Ô∏è‚É£ If NO vulns ‚Üí auto-close existing issue
            if (!hasFailures && existingIssue) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existingIssue.number,
                state: "closed"
              });
  
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existingIssue.number,
                body: "‚úÖ No SAST vulnerabilities detected. Closing issue automatically."
              });
  
              return;
            }
  
            // 4Ô∏è‚É£ If vulns exist ‚Üí create or update issue
            if (hasFailures) {
              const body = `
                    ### üö® SAST Vulnerabilities Detected
                    
                    **Workflow:** ${context.workflow}
                    **Branch:** ${context.ref}
                    **Commit:** ${context.sha}
                    
                    ### Scan Results
                    - **Snyk:** ${snykResult}
                    - **Semgrep:** ${semgrepResult}
                    - **SonarQube:** ${sonarqubeResult}
                    
                    üîó **Run details**
                    https://github.com/${owner}/${repo}/actions/runs/${context.runId}
                    
                    ‚õî This issue will auto-close when vulnerabilities are fixed.
                                `;
                    
                                if (existingIssue) {
                                  await github.rest.issues.createComment({
                                    owner,
                                    repo,
                                    issue_number: existingIssue.number,
                                    body
                                  });
                                } else {
                                  await github.rest.issues.create({
                                    owner,
                                    repo,
                                    title,
                                    body,
                                    labels: [label]
                                  });
                                }
                              }


