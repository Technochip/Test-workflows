name: Secret Scanning

on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    paths-ignore:
      - '.git/**'
      - '.github/**'
    branches:
      - dev

  schedule:
    - cron: "39 10 * * *"

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:

  Gitleaks-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          sudo apt install gitleaks -y

      - name: Run Gitleaks
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        run: gitleaks detect --no-git -v --redact --exit-code 1


  Trufflehog-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
  
      - name: Run TruffleHog via Docker
        run: |

         docker run --rm  \
          -v "$PWD:/pwd" \
          trufflesecurity/trufflehog:latest \
          filesystem /pwd \
          --github-actions \
          --exclude-paths /pwd/.trufflehog-ignore --fail


  create_secret_issue:
    name: Create / Update Secret Scan Issue
    needs: [Gitleaks-scan, Trufflehog-scan]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      issues: write
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Capture Gitleaks output
        run: |
          gitleaks detect --no-git -v --redact --exit-code 1 > gitleaks-output.txt || true
  
      - name: Capture TruffleHog output
        run: |
          docker run --rm \
            -v "$PWD:/pwd" \
            trufflesecurity/trufflehog:latest \
            filesystem /pwd \
            --github-actions \
            --exclude-paths /pwd/.trufflehog-ignore --fail > trufflehog-output.txt || true
  
      - name: Create / Update GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
  
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "security:secrets";
            const title = "ðŸš¨ Secret Scan Vulnerabilities Detected";
  
            const readFileSafe = (path) => fs.existsSync(path) ? fs.readFileSync(path, "utf8").trim() : "";
  
            const gitleaksOutput = readFileSafe("gitleaks-output.txt");
            const trufflehogOutput = readFileSafe("trufflehog-output.txt");
  
            const secretsFound = gitleaksOutput !== "" || trufflehogOutput !== "";
  
            const combinedOutput = `
              ### Gitleaks Scan Output
              \`\`\`
              ${gitleaksOutput || "No issues found."}
              \`\`\`
              
              ### TruffleHog Scan Output
              \`\`\`
              ${trufflehogOutput || "No issues found."}
              \`\`\`
                        `;
              
                        const issues = await github.rest.issues.listForRepo({
                          owner,
                          repo,
                          state: "open",
                          labels: label
                        });
              
                        const existingIssue = issues.data.find(i => i.title === title);
              
                        if (!secretsFound && existingIssue) {
                          // Close the issue if nothing found
                          await github.rest.issues.update({
                            owner,
                            repo,
                            issue_number: existingIssue.number,
                            state: "closed"
                          });
                          return;
                        }
              
                        if (secretsFound) {
                          const body = `
              ### ðŸš¨ Secret Scan Vulnerabilities Detected
              
              **Workflow:** ${context.workflow}  
              **Branch:** ${context.ref}  
              **Commit:** ${context.sha}
              
              ${combinedOutput}
              
              ðŸ”— **Run details:** https://github.com/${owner}/${repo}/actions/runs/${context.runId}
              
              â›” This issue is automatically updated on every scan.
                          `;
              
                          if (existingIssue) {
                            // Update existing issue
                            await github.rest.issues.update({
                              owner,
                              repo,
                              issue_number: existingIssue.number,
                              body
                            });
                          } else {
                            // Create new issue
                            await github.rest.issues.create({
                              owner,
                              repo,
                              title,
                              body,
                              labels: [label]
                            });
                          }
                        }

