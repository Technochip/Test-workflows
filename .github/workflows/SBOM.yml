name: Secret Scanning

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [dev]
  schedule:
    - cron: "39 10 * * *"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:

# =========================
# SCAN JOB (RUN ONCE)
# =========================
  secret-scan:
    runs-on: ubuntu-latest

    outputs:
      gitleaks_found: ${{ steps.gitleaks.outputs.found }}
      trufflehog_found: ${{ steps.trufflehog.outputs.found }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- Gitleaks ----
      - name: Install Gitleaks
        run: |
          sudo apt update
          sudo apt install gitleaks -y

      - name: Run Gitleaks
        id: gitleaks
        run: |
          gitleaks detect --no-git -v --redact \
            && echo "found=false" >> $GITHUB_OUTPUT \
            || echo "found=true" >> $GITHUB_OUTPUT

          gitleaks detect --no-git -v --redact > gitleaks-output.txt || true

      # ---- TruffleHog ----
      - name: Run TruffleHog
        id: trufflehog
        run: |
          docker run --rm \
            -v "$PWD:/pwd" \
            trufflesecurity/trufflehog:latest \
            filesystem /pwd --fail \
            && echo "found=false" >> $GITHUB_OUTPUT \
            || echo "found=true" >> $GITHUB_OUTPUT

          docker run --rm \
            -v "$PWD:/pwd" \
            trufflesecurity/trufflehog:latest \
            filesystem /pwd --fail \
            > trufflehog-output.txt || true

      # ---- Upload artifacts ----
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-reports
          path: |
            gitleaks-output.txt
            trufflehog-output.txt

# =========================
# ISSUE JOB (NO SCANNING)
# =========================
  create_secret_issue:
    name: Create / Update Secret Scan Issue
    needs: secret-scan
    runs-on: ubuntu-latest
    if: always()

    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: secret-scan-reports

      - name: Create / Update GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "security:secrets";
            const title = "ğŸš¨ Hard Coded  Detected";

            const gitleaksFound =
              "${{ needs.secret-scan.outputs.gitleaks_found }}" === "true";
            const trufflehogFound =
              "${{ needs.secret-scan.outputs.trufflehog_found }}" === "true";

            const secretsFound = gitleaksFound || trufflehogFound;

            const read = (f) =>
              fs.existsSync(f) ? fs.readFileSync(f, "utf8").trim() : "No issues found.";

            const gitleaksOutput = read("gitleaks-output.txt");
            const trufflehogOutput = read("trufflehog-output.txt");

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label
            });

            const existingIssue = issues.data.find(i => i.title === title);

            // ğŸŸ¢ No secrets â†’ close issue
            if (!secretsFound && existingIssue) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existingIssue.number,
                state: "closed"
              });
              return;
            }

            // ğŸ”´ Secrets found â†’ create/update issue
            if (secretsFound) {
              const body = `
### ğŸš¨ Secret Scan Vulnerabilities Detected

**Workflow:** ${context.workflow}  
**Branch:** ${context.ref}  
**Commit:** ${context.sha}

---

### ğŸ” Gitleaks
\`\`\`
${gitleaksOutput}
\`\`\`

---

### ğŸ” TruffleHog
\`\`\`
${trufflehogOutput}
\`\`\`

ğŸ”— **Run:** https://github.com/${owner}/${repo}/actions/runs/${context.runId}

â›” This issue is automatically managed by GitHub Actions.
              `;

              if (existingIssue) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existingIssue.number,
                  body
                });
              } else {
                await github.rest.issues.create({
                  owner,
                  repo,
                  title,
                  body,
                  labels: [label]
                });
              }
            }
